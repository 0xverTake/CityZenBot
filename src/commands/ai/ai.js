const { SlashCommandBuilder, EmbedBuilder } = require('discord.js');
const AIService = require('../../services/AIService');

module.exports = {
    data: new SlashCommandBuilder()
        .setName('ai')
        .setDescription('ü§ñ Conseils IA pour Star Citizen 4.2 avec guides officiels RSI')
        .addSubcommand(subcommand =>
            subcommand
                .setName('conseil')
                .setDescription('Demander un conseil personnalis√© avec IA')
                .addStringOption(option =>
                    option.setName('question')
                        .setDescription('Votre question sur Star Citizen')
                        .setRequired(true))
                .addStringOption(option =>
                    option.setName('niveau')
                        .setDescription('Votre niveau de jeu')
                        .setRequired(false)
                        .addChoices(
                            { name: 'üå± D√©butant', value: 'debutant' },
                            { name: '‚ö° Interm√©diaire', value: 'intermediaire' },
                            { name: 'üèÜ Avanc√©', value: 'avance' }
                        ))
                .addStringOption(option =>
                    option.setName('categorie')
                        .setDescription('Cat√©gorie du conseil')
                        .setRequired(false)
                        .addChoices(
                            { name: 'üåü D√©butant', value: 'debutant' },
                            { name: '‚öîÔ∏è Combat', value: 'combat' },
                            { name: 'üí∞ Commerce', value: 'commerce' },
                            { name: '‚õèÔ∏è Minage', value: 'minage' },
                            { name: 'üîç Exploration', value: 'exploration' },
                            { name: '‚ÑπÔ∏è G√©n√©ral', value: 'general' }
                        )))
        .addSubcommand(subcommand =>
            subcommand
                .setName('guides')
                .setDescription('Consulter les guides officiels RSI Spectrum')
                .addStringOption(option =>
                    option.setName('categorie')
                        .setDescription('Cat√©gorie de guide')
                        .setRequired(false)
                        .addChoices(
                            { name: 'üåü D√©butant', value: 'debutant' },
                            { name: '‚öîÔ∏è Combat', value: 'combat' },
                            { name: 'üí∞ Commerce', value: 'economie' },
                            { name: '‚õèÔ∏è Minage', value: 'minage' },
                            { name: 'üîç Exploration', value: 'exploration' }
                        )))
        .addSubcommand(subcommand =>
            subcommand
                .setName('nouveautes')
                .setDescription('D√©couvrir les nouveaut√©s Star Citizen 4.2'))
        .addSubcommand(subcommand =>
            subcommand
                .setName('status')
                .setDescription('Statut du service IA et guides')),

    async execute(interaction) {
        const aiService = new AIService();
        const subcommand = interaction.options.getSubcommand();

        try {
            if (subcommand === 'conseil') {
                await this.handleAdviceRequest(interaction, aiService);
            } else if (subcommand === 'guides') {
                await this.handleGuidesRequest(interaction, aiService);
            } else if (subcommand === 'nouveautes') {
                await this.handleUpdatesRequest(interaction, aiService);
            } else if (subcommand === 'status') {
                await this.handleStatusRequest(interaction, aiService);
            }
        } catch (error) {
            console.error('Erreur commande IA:', error);
            
            const errorEmbed = new EmbedBuilder()
                .setColor('#FF0000')
                .setTitle('‚ùå Erreur IA')
                .setDescription('Une erreur est survenue avec le service IA.')
                .addFields({
                    name: 'Solution',
                    value: 'R√©essayez dans quelques instants ou utilisez `/help` pour les guides manuels.'
                });

            await interaction.editReply({ embeds: [errorEmbed] });
        }
    },

    async handleAdviceRequest(interaction, aiService) {
        await interaction.deferReply();

        const question = interaction.options.getString('question');
        const playerLevel = interaction.options.getString('niveau') || 'debutant';
        const category = interaction.options.getString('categorie') || 'general';

        // G√©n√©rer le conseil IA enrichi avec guides Spectrum
        const advice = await aiService.getAdvice(question, category, playerLevel);

        const embed = new EmbedBuilder()
            .setColor('#00D4FF')
            .setTitle('ü§ñ Conseil IA Star Citizen 4.2')
            .setDescription(advice.ai_advice)
            .addFields([
                {
                    name: 'üìä D√©tails',
                    value: `**Niveau:** ${this.getLevelEmoji(playerLevel)} ${playerLevel}\n**Cat√©gorie:** ${this.getCategoryEmoji(advice.category)} ${advice.category}`,
                    inline: true
                },
                {
                    name: 'ü§ñ Source',
                    value: advice.fallback ? 'üìö Base de connaissances' : '‚ú® IA + Guides RSI',
                    inline: true
                }
            ]);

        // Ajouter les conseils Spectrum si disponibles
        if (advice.spectrum_tips && advice.spectrum_tips.length > 0) {
            embed.addFields({
                name: 'üìö Conseils officiels RSI',
                value: advice.spectrum_tips.map(tip => `‚Ä¢ ${tip}`).join('\n'),
                inline: false
            });
        }

        // Ajouter les nouveaut√©s SC 4.2 si pertinentes
        if (advice.sc42_features && advice.sc42_features.length > 0) {
            embed.addFields({
                name: 'üÜï Nouveaut√©s Star Citizen 4.2',
                value: advice.sc42_features.map(feature => `‚Ä¢ ${feature}`).join('\n'),
                inline: false
            });
        }

        // Ajouter les conseils rapides
        if (advice.quick_tips && advice.quick_tips.length > 0) {
            embed.addFields({
                name: 'üí° Conseils rapides',
                value: advice.quick_tips.join('\n'),
                inline: false
            });
        }

        // Ajouter les commandes li√©es
        if (advice.related_commands && advice.related_commands.length > 0) {
            embed.addFields({
                name: 'üîó Commandes utiles',
                value: advice.related_commands.map(cmd => `\`${cmd}\``).join(' ‚Ä¢ '),
                inline: false
            });
        }

        embed.addFields({
            name: 'üìñ Guides officiels',
            value: advice.official_guides,
            inline: false
        });

        embed.setFooter({ 
            text: `CityZenBot v2.0.1 ‚Ä¢ IA Open Source + RSI Spectrum ‚Ä¢ SC ${advice.sc_version}` 
        })
        .setTimestamp();

        await interaction.editReply({ embeds: [embed] });
    },

    async handleGuidesRequest(interaction, aiService) {
        await interaction.deferReply();

        const category = interaction.options.getString('categorie');

        if (category) {
            // Guide sp√©cifique
            const guide = aiService.spectrumService.getGuideByCategory(category);
            
            if (!guide) {
                const embed = new EmbedBuilder()
                    .setColor('#FFA500')
                    .setTitle('‚ùì Guide non trouv√©')
                    .setDescription(`Aucun guide trouv√© pour la cat√©gorie "${category}".`)
                    .addFields({
                        name: 'üìö Guides disponibles',
                        value: 'Utilisez `/ai guides` sans param√®tre pour voir tous les guides.',
                        inline: false
                    });
                
                return await interaction.editReply({ embeds: [embed] });
            }

            const embed = new EmbedBuilder()
                .setColor('#FFD700')
                .setTitle(`üìö ${guide.title}`)
                .setDescription(`Guide officiel RSI Spectrum pour ${guide.category}`)
                .addFields([
                    {
                        name: 'üéØ Cat√©gorie',
                        value: `${this.getCategoryEmoji(guide.category)} ${guide.category}`,
                        inline: true
                    },
                    {
                        name: 'üè∑Ô∏è Tags',
                        value: guide.tags.map(tag => `\`${tag}\``).join(' '),
                        inline: true
                    },
                    {
                        name: 'üí° Conseils essentiels',
                        value: guide.tips.map(tip => `‚Ä¢ ${tip}`).join('\n'),
                        inline: false
                    },
                    {
                        name: 'üîó Lien officiel',
                        value: `[Consulter le guide complet](${guide.url})`,
                        inline: false
                    }
                ]);
        } else {
            // Liste de tous les guides
            const allGuides = aiService.spectrumService.getAllGuides();
            
            const embed = new EmbedBuilder()
                .setColor('#00D4FF')
                .setTitle('üìö Guides officiels RSI Spectrum')
                .setDescription('Guides officiels pour Star Citizen 4.2')
                .addFields(
                    allGuides.map(guide => ({
                        name: `${this.getCategoryEmoji(guide.category)} ${guide.title}`,
                        value: `**Cat√©gorie:** ${guide.category}\n**Tags:** ${guide.tags.join(', ')}\n[Consulter le guide](${guide.url})`,
                        inline: true
                    }))
                );
        }

        embed.setFooter({ text: 'CityZenBot ‚Ä¢ Guides officiels RSI Spectrum ‚Ä¢ Star Citizen 4.2' })
             .setTimestamp();

        await interaction.editReply({ embeds: [embed] });
    },

    async handleUpdatesRequest(interaction, aiService) {
        await interaction.deferReply();

        const updates = aiService.spectrumService.getSC42Updates();

        const embed = new EmbedBuilder()
            .setColor('#00FF88')
            .setTitle('üÜï Star Citizen 4.2 - Nouveaut√©s')
            .setDescription('D√©couvrez les derni√®res fonctionnalit√©s et am√©liorations')
            .addFields([
                {
                    name: '‚ú® Nouvelles fonctionnalit√©s',
                    value: updates.nouveautes.map(item => `‚Ä¢ ${item}`).join('\n'),
                    inline: false
                },
                {
                    name: 'üîß Corrections importantes',
                    value: updates.corrections.map(item => `‚Ä¢ ${item}`).join('\n'),
                    inline: false
                },
                {
                    name: 'üí° Conseils pour la version 4.2',
                    value: updates.conseils.map(item => `‚Ä¢ ${item}`).join('\n'),
                    inline: false
                }
            ])
            .setFooter({ text: `Mise √† jour Star Citizen ${updates.version} ‚Ä¢ ${updates.lastUpdated}` })
            .setTimestamp();

        await interaction.editReply({ embeds: [embed] });
    },

    async handleStatusRequest(interaction, aiService) {
        await interaction.deferReply();

        const stats = aiService.getUsageStats();
        const spectrumStats = aiService.spectrumService.getStats();

        const embed = new EmbedBuilder()
            .setColor(stats.enabled ? '#00FF00' : '#FFA500')
            .setTitle('ü§ñ Statut Service IA + Guides RSI')
            .setDescription(stats.enabled ? 
                '‚úÖ **Service IA op√©rationnel** - Conseils intelligents + Guides officiels' : 
                '‚ö†Ô∏è **IA indisponible** - Guides RSI + Base de connaissances actifs');

        // Statut IA
        const aiStatus = stats.enabled ? 
            `‚úÖ **${stats.api_provider}**\nüìä Mod√®le: ${stats.model}\nüéØ Taux de cache: ${stats.hit_rate}%` :
            `‚ùå **Indisponible**\nüìö Mode fallback actif`;

        embed.addFields([
            {
                name: 'ü§ñ Intelligence Artificielle',
                value: aiStatus,
                inline: true
            },
            {
                name: 'üìö Guides RSI Spectrum',
                value: `‚úÖ **Op√©rationnel**\nüìñ ${spectrumStats.totalGuides} guides disponibles\nüè∑Ô∏è ${spectrumStats.categoriesAvailable.length} cat√©gories`,
                inline: true
            },
            {
                name: 'üìä Statistiques d\'utilisation',
                value: `üîÑ **Requ√™tes:** ${stats.requests_total}\nüíæ **Cache:** ${stats.cache_size} entr√©es\n‚è±Ô∏è **Uptime:** ${stats.uptime_hours}h`,
                inline: false
            }
        ]);

        // Guides disponibles
        embed.addFields({
            name: 'üìö Cat√©gories de guides disponibles',
            value: spectrumStats.categoriesAvailable.map(cat => `‚Ä¢ ${this.getCategoryEmoji(cat)} ${cat}`).join('\n'),
            inline: false
        });

        // Compatibilit√©
        embed.addFields({
            name: 'üéÆ Compatibilit√©',
            value: `‚úÖ **Star Citizen 4.2**\n‚úÖ **APIs publiques int√©gr√©es**\n‚úÖ **Guides RSI Spectrum**\n‚úÖ **IA open source gratuite**`,
            inline: false
        });

        embed.setFooter({ 
            text: `CityZenBot v${spectrumStats.version} ‚Ä¢ Open Source ‚Ä¢ Gratuit ‚Ä¢ SC 4.2 Compatible` 
        })
        .setTimestamp();

        await interaction.editReply({ embeds: [embed] });
    },

    getLevelEmoji(level) {
        const emojis = {
            'debutant': 'üå±',
            'intermediaire': '‚ö°',
            'avance': 'üèÜ'
        };
        return emojis[level] || '‚ùì';
    },

    getCategoryEmoji(category) {
        const emojis = {
            'debutant': 'üåü',
            'combat': '‚öîÔ∏è',
            'commerce': 'üí∞',
            'economie': 'üí∞',
            'minage': '‚õèÔ∏è',
            'exploration': 'üîç',
            'general': '‚ÑπÔ∏è'
        };
        return emojis[category] || 'üìù';
    }
};
